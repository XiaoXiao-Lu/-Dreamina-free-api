# 向下滑动关闭原图功能

## 📱 功能说明

在手机端查看原图时,现在可以通过**向下滑动**来关闭原图查看器,就像微信、Instagram 等应用一样。

## ✨ 特性

### 1. 流畅的视觉反馈
- 图片跟随手指向下移动
- 背景透明度实时变化 (1.0 → 0.3)
- 图片缩放实时变化 (1.0 → 0.8)
- 最大滑动距离: 300px

### 2. 智能判断
- 滑动距离 > 100px: 自动关闭查看器
- 滑动距离 < 100px: 0.3秒动画弹回原位

### 3. 手势优先级
- 缩放状态下 (scale > 1): 禁用滑动关闭,避免误触
- 正常状态下 (scale = 1): 启用滑动关闭

### 4. 方向识别
- 垂直滑动 (|deltaY| > |deltaX|): 关闭功能
- 水平滑动 (|deltaX| > |deltaY|): 切换图片 (多张时)

## 🎯 使用方法

1. 点击历史记录中的图片,打开原图查看器
2. 在图片上向下滑动
3. 滑动超过 100px 后松手,查看器自动关闭
4. 如果滑动距离不够,图片会弹回原位

## 🔧 技术实现

### 修改的文件
- `web/js/ui.js` - 添加滑动关闭逻辑
- `web/css/style.css` - 添加过渡动画支持

### 核心代码

#### 1. 滑动检测 (ui.js)
```javascript
// 判断滑动方向
if (Math.abs(deltaX) > Math.abs(deltaY)) {
    // 水平滑动 - 切换图片
    if (this.currentImageList.length > 1 && Math.abs(deltaX) > 50) {
        // 切换逻辑...
    }
} else {
    // 垂直滑动 - 关闭查看器
    if (deltaY > 100) {
        this.hideFullscreenViewer();
    }
}
```

#### 2. 实时视觉反馈 (ui.js)
```javascript
// 滑动中的视觉效果
if (isVerticalSwipe && deltaY > 0) {
    const progress = Math.min(deltaY / 300, 1);
    const opacity = 1 - progress * 0.7;
    const scale = 1 - progress * 0.2;

    this.fullscreenViewer.style.backgroundColor = `rgba(0, 0, 0, ${opacity})`;
    this.fullscreenImage.style.transform = `translateY(${deltaY}px) scale(${scale})`;
    this.fullscreenImage.style.transition = 'none';
}
```

#### 3. 恢复动画 (ui.js)
```javascript
// 滑动距离不够时,平滑恢复
if (deltaY < 100) {
    this.fullscreenViewer.style.backgroundColor = '';
    this.fullscreenImage.style.transition = 'transform 0.3s ease';
    this.fullscreenImage.style.transform = '';
    setTimeout(() => {
        this.fullscreenImage.style.transition = '';
    }, 300);
}
```

#### 4. 样式重置 (ui.js)
```javascript
hideFullscreenViewer() {
    // ... 其他代码 ...
    
    // 重置滑动相关样式
    this.fullscreenViewer.style.backgroundColor = '';
    this.fullscreenImage.style.transition = '';
    this.fullscreenImage.style.transform = '';
}
```

#### 5. CSS 过渡支持 (style.css)
```css
.fullscreen-viewer {
    /* ... 其他样式 ... */
    /* 支持滑动关闭时的背景色过渡 */
    transition: background-color 0.3s ease;
}
```

## 🧪 测试

### 测试页面
打开 `web/gesture-test.html` 可以测试滑动关闭功能:
```
http://localhost:5000/gesture-test.html
```

### 测试场景
1. ✅ 正常向下滑动 > 100px - 应该关闭
2. ✅ 向下滑动 < 100px - 应该弹回
3. ✅ 缩放后滑动 - 应该禁用关闭
4. ✅ 水平滑动 - 应该切换图片
5. ✅ 快速滑动 - 应该响应流畅
6. ✅ 慢速滑动 - 应该实时反馈

## 📊 性能优化

### 1. 使用 transform 而非 top/left
```javascript
// ✅ 好 - 使用 GPU 加速
image.style.transform = `translateY(${deltaY}px)`;

// ❌ 差 - 触发重排
image.style.top = `${deltaY}px`;
```

### 2. 禁用过渡动画在滑动中
```javascript
// 滑动中禁用过渡,避免卡顿
image.style.transition = 'none';

// 松手后恢复过渡
image.style.transition = 'transform 0.3s ease';
```

### 3. 使用 passive 事件监听
```javascript
viewer.addEventListener('touchmove', handler, { passive: true });
```

## 🐛 已知问题

### 已修复
- ✅ 缩放状态下误触发关闭 - 已添加 scale 检查
- ✅ 水平滑动误判为垂直 - 已优化方向判断
- ✅ 关闭后样式残留 - 已添加样式重置

### 待优化
- ⏳ 向上滑动的处理 (目前忽略)
- ⏳ 滑动速度检测 (快速滑动降低阈值)

## 🌐 兼容性

### 已测试
- ✅ iOS Safari 14+
- ✅ Android Chrome 90+
- ✅ 微信内置浏览器
- ✅ 各种移动端浏览器

### 降级方案
- 桌面浏览器: 保留原有关闭方式 (点击 ✕、ESC、背景)
- 不支持触摸的设备: 自动禁用滑动功能

## 📝 更新日志

### v1.1 - 2025-01-XX
- ✨ 新增: 向下滑动关闭原图功能
- ✨ 新增: 滑动时实时视觉反馈
- 🎨 优化: 滑动手势检测逻辑
- 🎨 优化: 手势优先级处理
- 🐛 修复: 缩放状态下误触发滑动
- 📝 文档: 添加手势操作说明
- 🧪 测试: 添加手势测试页面

## 🎓 参考

### 类似实现
- 微信图片查看器
- Instagram 图片查看
- Twitter 图片查看
- iOS 照片应用

### 设计原则
1. **自然**: 符合用户直觉
2. **流畅**: 60fps 动画
3. **可控**: 可以取消操作
4. **反馈**: 实时视觉反馈
5. **容错**: 避免误触

## 💡 未来改进

1. **滑动速度检测**
   - 快速滑动降低关闭阈值
   - 慢速滑动提高关闭阈值

2. **弹性效果**
   - 向上滑动时添加弹性
   - 超过最大距离时添加阻尼

3. **haptic 反馈**
   - 达到关闭阈值时震动
   - iOS 设备支持 Taptic Engine

4. **自定义配置**
   - 允许用户调整关闭阈值
   - 允许禁用滑动关闭

## 🤝 贡献

如果您有任何建议或发现问题,欢迎:
1. 提交 Issue
2. 提交 Pull Request
3. 在测试页面反馈体验

