<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>诊断工具 - Dreamina AI</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        h1 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .section {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .section h2 {
            font-size: 18px;
            margin-bottom: 10px;
            color: #333;
        }

        .result {
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
        }

        .success {
            background: #d4edda;
            color: #155724;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
        }

        .info {
            background: #d1ecf1;
            color: #0c5460;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }

        button:hover {
            background: #5568d3;
        }

        pre {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 诊断工具</h1>

        <div class="section">
            <h2>1. 基本信息</h2>
            <div id="basic-info"></div>
        </div>

        <div class="section">
            <h2>2. API 配置</h2>
            <div id="api-config"></div>
        </div>

        <div class="section">
            <h2>3. 测试账号 API</h2>
            <button onclick="testAccountsAPI()">测试 GET /api/accounts</button>
            <div id="accounts-result"></div>
        </div>

        <div class="section">
            <h2>4. 测试 StorageManager</h2>
            <button onclick="testStorageManager()">测试 StorageManager</button>
            <div id="storage-result"></div>
        </div>

        <div class="section">
            <h2>5. JavaScript 错误日志</h2>
            <div id="error-log"></div>
        </div>
    </div>

    <script src="js/config.js?v=4"></script>
    <script src="js/api.js?v=4"></script>

    <script>
        // 错误日志
        const errors = [];
        window.onerror = function(msg, url, line, col, error) {
            errors.push({
                message: msg,
                url: url,
                line: line,
                col: col,
                error: error
            });
            updateErrorLog();
        };

        // 显示基本信息
        function showBasicInfo() {
            const info = document.getElementById('basic-info');
            info.innerHTML = `
                <div class="result info">
                    <strong>User Agent:</strong> ${navigator.userAgent}<br>
                    <strong>当前 URL:</strong> ${window.location.href}<br>
                    <strong>屏幕尺寸:</strong> ${window.innerWidth} x ${window.innerHeight}<br>
                    <strong>时间:</strong> ${new Date().toLocaleString()}
                </div>
            `;
        }

        // 显示 API 配置
        function showAPIConfig() {
            const config = document.getElementById('api-config');
            try {
                config.innerHTML = `
                    <div class="result success">
                        <strong>CONFIG 对象存在:</strong> ✅<br>
                        <strong>API Base URL:</strong> ${CONFIG.api.baseUrl}<br>
                        <strong>Storage Keys:</strong> ${JSON.stringify(CONFIG.storage, null, 2)}
                    </div>
                `;
            } catch (e) {
                config.innerHTML = `
                    <div class="result error">
                        <strong>错误:</strong> ${e.message}
                    </div>
                `;
            }
        }

        // 测试账号 API
        async function testAccountsAPI() {
            const result = document.getElementById('accounts-result');
            result.innerHTML = '<div class="result info">正在测试...</div>';

            try {
                const response = await fetch(`${CONFIG.api.baseUrl}/accounts`);
                const data = await response.json();

                if (data.success) {
                    result.innerHTML = `
                        <div class="result success">
                            <strong>✅ API 调用成功</strong><br>
                            <strong>账号数量:</strong> ${data.accounts.length}<br>
                            <strong>账号列表:</strong>
                            <pre>${JSON.stringify(data.accounts, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    result.innerHTML = `
                        <div class="result error">
                            <strong>❌ API 返回失败</strong><br>
                            <strong>消息:</strong> ${data.message}
                        </div>
                    `;
                }
            } catch (e) {
                result.innerHTML = `
                    <div class="result error">
                        <strong>❌ API 调用失败</strong><br>
                        <strong>错误:</strong> ${e.message}<br>
                        <strong>Stack:</strong> ${e.stack}
                    </div>
                `;
            }
        }

        // 测试 StorageManager
        async function testStorageManager() {
            const result = document.getElementById('storage-result');
            result.innerHTML = '<div class="result info">正在测试...</div>';

            try {
                // 检查 storage 对象是否存在
                if (typeof storage === 'undefined') {
                    result.innerHTML = `
                        <div class="result error">
                            <strong>❌ storage 对象不存在</strong><br>
                            这可能是因为 api.js 没有正确加载或初始化
                        </div>
                    `;
                    return;
                }

                // 测试 getAccounts
                const accounts = await storage.getAccounts();
                
                result.innerHTML = `
                    <div class="result success">
                        <strong>✅ StorageManager 工作正常</strong><br>
                        <strong>获取到的账号数量:</strong> ${accounts.length}<br>
                        <strong>账号列表:</strong>
                        <pre>${JSON.stringify(accounts, null, 2)}</pre>
                    </div>
                `;
            } catch (e) {
                result.innerHTML = `
                    <div class="result error">
                        <strong>❌ StorageManager 测试失败</strong><br>
                        <strong>错误:</strong> ${e.message}<br>
                        <strong>Stack:</strong> ${e.stack}
                    </div>
                `;
            }
        }

        // 更新错误日志
        function updateErrorLog() {
            const log = document.getElementById('error-log');
            if (errors.length === 0) {
                log.innerHTML = '<div class="result success">✅ 没有 JavaScript 错误</div>';
            } else {
                log.innerHTML = errors.map(err => `
                    <div class="result error">
                        <strong>错误:</strong> ${err.message}<br>
                        <strong>文件:</strong> ${err.url}<br>
                        <strong>行号:</strong> ${err.line}:${err.col}
                    </div>
                `).join('');
            }
        }

        // 初始化
        window.onload = function() {
            showBasicInfo();
            showAPIConfig();
            updateErrorLog();

            // 自动测试
            setTimeout(() => {
                testAccountsAPI();
                testStorageManager();
            }, 500);
        };
    </script>
</body>
</html>

