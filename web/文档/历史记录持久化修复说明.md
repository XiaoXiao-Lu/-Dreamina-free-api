# ğŸ“š å†å²è®°å½•æŒä¹…åŒ–ä¿®å¤è¯´æ˜

**å®ç°æ—¶é—´**: 2025-10-03 21:52  
**ç‰ˆæœ¬**: v11.2  
**çŠ¶æ€**: âœ… å·²å®Œæˆ  

---

## ğŸ“‹ ä¿®å¤çš„é—®é¢˜

### é—®é¢˜: å†å²è®°å½•åˆ·æ–°åè¢«æ¸…ç©º âŒ

**ç°è±¡**: 
- ç”Ÿæˆå›¾ç‰‡å,å†å²è®°å½•æ˜¾ç¤ºæ­£å¸¸
- åˆ·æ–°ç½‘é¡µæˆ–é‡å¯æœåŠ¡å™¨å,å†å²è®°å½•å…¨éƒ¨æ¶ˆå¤±
- æ‰€æœ‰å®¢æˆ·ç«¯çš„å†å²è®°å½•éƒ½è¢«æ¸…ç©º

**åŸå› **: 
å†å²è®°å½•åªå­˜å‚¨åœ¨æœåŠ¡å™¨çš„å†…å­˜å˜é‡ä¸­(`history_records = []`),æœåŠ¡å™¨é‡å¯åå†…å­˜è¢«æ¸…ç©º,å¯¼è‡´å†å²è®°å½•ä¸¢å¤±ã€‚

**å½±å“**:
- âŒ ç”¨æˆ·æ— æ³•æŸ¥çœ‹ä¹‹å‰çš„ç”Ÿæˆè®°å½•
- âŒ æ— æ³•é‡ç”¨ä¹‹å‰çš„æç¤ºè¯å’Œå‚æ•°
- âŒ ç”¨æˆ·ä½“éªŒå·®

---

## ğŸ¯ è§£å†³æ–¹æ¡ˆ

### æ ¸å¿ƒæ€è·¯

å°†å†å²è®°å½•æŒä¹…åŒ–åˆ°æ–‡ä»¶ç³»ç»Ÿ,è€Œä¸æ˜¯åªå­˜å‚¨åœ¨å†…å­˜ä¸­:

1. **ä¿å­˜åˆ°æ–‡ä»¶**: æ¯æ¬¡æ·»åŠ ã€åˆ é™¤æˆ–æ¸…ç©ºå†å²è®°å½•æ—¶,åŒæ­¥ä¿å­˜åˆ°JSONæ–‡ä»¶
2. **å¯åŠ¨æ—¶åŠ è½½**: æœåŠ¡å™¨å¯åŠ¨æ—¶ä»æ–‡ä»¶åŠ è½½å†å²è®°å½•
3. **è‡ªåŠ¨åŒæ­¥**: æ‰€æœ‰æ“ä½œéƒ½ä¼šè‡ªåŠ¨ä¿å­˜åˆ°æ–‡ä»¶

### æŠ€æœ¯å®ç°

**æ–‡ä»¶ä½ç½®**: `web/history.json`  
**æ ¼å¼**: JSONæ•°ç»„  
**ç¼–ç **: UTF-8  

---

## ğŸ”§ è¯¦ç»†å®ç°

### 1. å®šä¹‰å†å²è®°å½•æ–‡ä»¶è·¯å¾„

**æ–‡ä»¶**: `web/server.py` ç¬¬694-696è¡Œ

```python
# å†å²è®°å½•ç®¡ç†
HISTORY_FILE = Path(__file__).parent / 'history.json'
MAX_HISTORY_RECORDS = 100  # æœ€å¤šä¿å­˜100æ¡è®°å½•
```

**è¯´æ˜**:
- ä½¿ç”¨`Path`å¯¹è±¡ç¡®ä¿è·¨å¹³å°å…¼å®¹
- æ–‡ä»¶ä¿å­˜åœ¨`web`ç›®å½•ä¸‹
- é™åˆ¶æœ€å¤š100æ¡è®°å½•,é˜²æ­¢æ–‡ä»¶è¿‡å¤§

---

### 2. åŠ è½½å†å²è®°å½•å‡½æ•°

**æ–‡ä»¶**: `web/server.py` ç¬¬698-706è¡Œ

```python
def load_history():
    """ä»æ–‡ä»¶åŠ è½½å†å²è®°å½•"""
    try:
        if HISTORY_FILE.exists():
            with open(HISTORY_FILE, 'r', encoding='utf-8') as f:
                return json.load(f)
    except Exception as e:
        logger.error(f"åŠ è½½å†å²è®°å½•å¤±è´¥: {e}")
    return []
```

**åŠŸèƒ½**:
- æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
- è¯»å–JSONæ–‡ä»¶
- è§£æä¸ºPythonåˆ—è¡¨
- é”™è¯¯å¤„ç†:å¦‚æœåŠ è½½å¤±è´¥,è¿”å›ç©ºåˆ—è¡¨

**é”™è¯¯å¤„ç†**:
- æ–‡ä»¶ä¸å­˜åœ¨ â†’ è¿”å›ç©ºåˆ—è¡¨
- JSONæ ¼å¼é”™è¯¯ â†’ è®°å½•é”™è¯¯,è¿”å›ç©ºåˆ—è¡¨
- è¯»å–æƒé™é—®é¢˜ â†’ è®°å½•é”™è¯¯,è¿”å›ç©ºåˆ—è¡¨

---

### 3. ä¿å­˜å†å²è®°å½•å‡½æ•°

**æ–‡ä»¶**: `web/server.py` ç¬¬708-714è¡Œ

```python
def save_history(history_records):
    """ä¿å­˜å†å²è®°å½•åˆ°æ–‡ä»¶"""
    try:
        with open(HISTORY_FILE, 'w', encoding='utf-8') as f:
            json.dump(history_records, f, ensure_ascii=False, indent=2)
    except Exception as e:
        logger.error(f"ä¿å­˜å†å²è®°å½•å¤±è´¥: {e}")
```

**åŠŸèƒ½**:
- å°†å†å²è®°å½•åˆ—è¡¨å†™å…¥JSONæ–‡ä»¶
- ä½¿ç”¨UTF-8ç¼–ç æ”¯æŒä¸­æ–‡
- `ensure_ascii=False`: ä¿å­˜ä¸­æ–‡å­—ç¬¦è€Œä¸æ˜¯Unicodeè½¬ä¹‰
- `indent=2`: æ ¼å¼åŒ–è¾“å‡º,ä¾¿äºé˜…è¯»

**å‚æ•°è¯´æ˜**:
- `ensure_ascii=False`: å…è®¸ä¿å­˜ä¸­æ–‡å­—ç¬¦
- `indent=2`: æ¯å±‚ç¼©è¿›2ä¸ªç©ºæ ¼

---

### 4. å¯åŠ¨æ—¶åŠ è½½å†å²è®°å½•

**æ–‡ä»¶**: `web/server.py` ç¬¬716-717è¡Œ

```python
# åŠ è½½å†å²è®°å½•
history_records = load_history()
logger.info(f"åŠ è½½äº† {len(history_records)} æ¡å†å²è®°å½•")
```

**åŠŸèƒ½**:
- æœåŠ¡å™¨å¯åŠ¨æ—¶è‡ªåŠ¨åŠ è½½å†å²è®°å½•
- è®°å½•åŠ è½½çš„æ•°é‡åˆ°æ—¥å¿—
- å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨,è¿”å›ç©ºåˆ—è¡¨

**æ—¥å¿—è¾“å‡ºç¤ºä¾‹**:
```
2025-10-03 21:52:53,765 - __main__ - INFO - åŠ è½½äº† 5 æ¡å†å²è®°å½•
```

---

### 5. æ·»åŠ å†å²è®°å½•æ—¶ä¿å­˜

**æ–‡ä»¶**: `web/server.py` ç¬¬714-776è¡Œ

```python
@app.route('/api/history', methods=['POST'])
def add_history():
    """æ·»åŠ å†å²è®°å½•"""
    try:
        data = request.json

        # åˆ›å»ºå†å²è®°å½•é¡¹
        history_item = {
            'id': str(int(time.time() * 1000)),
            'timestamp': datetime.datetime.now().isoformat(),
            'prompt': data.get('prompt', ''),
            'model': data.get('model', ''),
            'resolution': data.get('resolution', ''),
            'ratio': data.get('ratio', ''),
            'mode': data.get('mode', 't2i'),
            'images': data.get('images', []),
            'historyId': data.get('historyId', '')
        }

        # æ·»åŠ åˆ°åˆ—è¡¨å¼€å¤´(æœ€æ–°çš„åœ¨å‰é¢)
        history_records.insert(0, history_item)

        # é™åˆ¶å†å²è®°å½•æ•°é‡
        if len(history_records) > MAX_HISTORY_RECORDS:
            history_records.pop()

        # ä¿å­˜åˆ°æ–‡ä»¶ â† å…³é”®ä¿®æ”¹
        save_history(history_records)

        logger.info(f"æ·»åŠ å†å²è®°å½•: {history_item['id']}, æç¤ºè¯: {history_item['prompt'][:50]}...")

        return jsonify({
            'success': True,
            'id': history_item['id']
        })
    except Exception as e:
        logger.error(f"æ·»åŠ å†å²è®°å½•å¤±è´¥: {e}")
        return jsonify({
            'success': False,
            'message': str(e)
        }), 500
```

**å…³é”®ç‚¹**:
- âœ… æ·»åŠ è®°å½•åç«‹å³è°ƒç”¨`save_history()`
- âœ… ç¡®ä¿æ•°æ®æŒä¹…åŒ–
- âœ… å³ä½¿æœåŠ¡å™¨é‡å¯ä¹Ÿä¸ä¼šä¸¢å¤±

---

### 6. åˆ é™¤å†å²è®°å½•æ—¶ä¿å­˜

**æ–‡ä»¶**: `web/server.py` ç¬¬778-795è¡Œ

```python
@app.route('/api/history/<history_id>', methods=['DELETE'])
def delete_history(history_id):
    """åˆ é™¤å†å²è®°å½•"""
    try:
        global history_records
        history_records = [h for h in history_records if h['id'] != history_id]
        
        # ä¿å­˜åˆ°æ–‡ä»¶ â† å…³é”®ä¿®æ”¹
        save_history(history_records)

        logger.info(f"åˆ é™¤å†å²è®°å½•: {history_id}")

        return jsonify({
            'success': True
        })
    except Exception as e:
        logger.error(f"åˆ é™¤å†å²è®°å½•å¤±è´¥: {e}")
        return jsonify({
            'success': False,
            'message': str(e)
        }), 500
```

**å…³é”®ç‚¹**:
- âœ… åˆ é™¤è®°å½•åç«‹å³ä¿å­˜
- âœ… æ‰€æœ‰å®¢æˆ·ç«¯åŒæ­¥æ›´æ–°

---

### 7. æ¸…ç©ºå†å²è®°å½•æ—¶ä¿å­˜

**æ–‡ä»¶**: `web/server.py` ç¬¬797-816è¡Œ

```python
@app.route('/api/history/clear', methods=['POST'])
def clear_history():
    """æ¸…ç©ºå†å²è®°å½•"""
    try:
        global history_records
        count = len(history_records)
        history_records = []
        
        # ä¿å­˜åˆ°æ–‡ä»¶ â† å…³é”®ä¿®æ”¹
        save_history(history_records)

        logger.info(f"æ¸…ç©ºå†å²è®°å½•ï¼Œå…±åˆ é™¤ {count} æ¡")

        return jsonify({
            'success': True,
            'count': count
        })
    except Exception as e:
        logger.error(f"æ¸…ç©ºå†å²è®°å½•å¤±è´¥: {e}")
        return jsonify({
            'success': False,
            'message': str(e)
        }), 500
```

**å…³é”®ç‚¹**:
- âœ… æ¸…ç©ºåç«‹å³ä¿å­˜ç©ºåˆ—è¡¨
- âœ… åˆ é™¤æ–‡ä»¶å†…å®¹

---

## ğŸ“Š æ•°æ®æ ¼å¼

### history.json æ–‡ä»¶æ ¼å¼

```json
[
  {
    "id": "1696348800000",
    "timestamp": "2025-10-03T21:30:00.000000",
    "prompt": "ä¸€åªå¯çˆ±çš„å°çŒ«",
    "model": "4.0",
    "resolution": "2k",
    "ratio": "1:1",
    "mode": "t2i",
    "images": [
      "https://p16-capcut-va.ibyteimg.com/...",
      "https://p16-capcut-va.ibyteimg.com/...",
      "https://p16-capcut-va.ibyteimg.com/...",
      "https://p16-capcut-va.ibyteimg.com/..."
    ],
    "historyId": "71831870826769"
  },
  {
    "id": "1696348900000",
    "timestamp": "2025-10-03T21:31:00.000000",
    "prompt": "ç¾ä¸½çš„é£æ™¯",
    "model": "3.0",
    "resolution": "2k",
    "ratio": "16:9",
    "mode": "t2i",
    "images": [
      "https://p16-capcut-va.ibyteimg.com/..."
    ],
    "historyId": "71831870826770"
  }
]
```

**å­—æ®µè¯´æ˜**:
- `id`: å”¯ä¸€æ ‡è¯†ç¬¦(æ—¶é—´æˆ³)
- `timestamp`: ISOæ ¼å¼æ—¶é—´æˆ³
- `prompt`: ç”¨æˆ·è¾“å…¥çš„æç¤ºè¯
- `model`: ä½¿ç”¨çš„æ¨¡å‹
- `resolution`: åˆ†è¾¨ç‡
- `ratio`: å®½é«˜æ¯”
- `mode`: ç”Ÿæˆæ¨¡å¼(t2i/i2i)
- `images`: ç”Ÿæˆçš„å›¾ç‰‡URLæ•°ç»„
- `historyId`: DreaminaæœåŠ¡å™¨çš„å†å²ID

---

## âœ… æµ‹è¯•æ­¥éª¤

### æµ‹è¯•1: åŸºæœ¬æŒä¹…åŒ–

1. **ç”Ÿæˆå›¾ç‰‡**: è¾“å…¥æç¤ºè¯å¹¶ç”Ÿæˆå›¾ç‰‡
2. **æŸ¥çœ‹å†å²**: æ‰“å¼€ä¾§è¾¹æ ,åº”è¯¥èƒ½çœ‹åˆ°å†å²è®°å½•
3. **åˆ·æ–°é¡µé¢**: æŒ‰ `F5` åˆ·æ–°
4. **éªŒè¯ç»“æœ**: 
   - âœ… å†å²è®°å½•ä»ç„¶å­˜åœ¨
   - âœ… å›¾ç‰‡ç¼©ç•¥å›¾æ­£å¸¸æ˜¾ç¤º

### æµ‹è¯•2: æœåŠ¡å™¨é‡å¯

1. **ç”Ÿæˆå›¾ç‰‡**: ç”Ÿæˆå‡ å¼ å›¾ç‰‡
2. **é‡å¯æœåŠ¡å™¨**: åœæ­¢å¹¶é‡æ–°å¯åŠ¨æœåŠ¡å™¨
3. **åˆ·æ–°é¡µé¢**: åˆ·æ–°æµè§ˆå™¨
4. **éªŒè¯ç»“æœ**:
   - âœ… å†å²è®°å½•ä»ç„¶å­˜åœ¨
   - âœ… æœåŠ¡å™¨æ—¥å¿—æ˜¾ç¤º"åŠ è½½äº† X æ¡å†å²è®°å½•"

### æµ‹è¯•3: å¤šå®¢æˆ·ç«¯åŒæ­¥

1. **å®¢æˆ·ç«¯A**: ç”Ÿæˆå›¾ç‰‡
2. **å®¢æˆ·ç«¯B**: åˆ·æ–°é¡µé¢
3. **éªŒè¯ç»“æœ**:
   - âœ… å®¢æˆ·ç«¯Bèƒ½çœ‹åˆ°å®¢æˆ·ç«¯Aç”Ÿæˆçš„è®°å½•

### æµ‹è¯•4: åˆ é™¤è®°å½•

1. **åˆ é™¤è®°å½•**: ç‚¹å‡»åˆ é™¤æŒ‰é’®
2. **åˆ·æ–°é¡µé¢**: æŒ‰ `F5` åˆ·æ–°
3. **éªŒè¯ç»“æœ**:
   - âœ… åˆ é™¤çš„è®°å½•ä¸å†æ˜¾ç¤º

---

## ğŸ“‚ ä¿®æ”¹çš„æ–‡ä»¶

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ | è¡Œæ•° |
|------|---------|------|
| `web/server.py` | æ·»åŠ å†å²è®°å½•æŒä¹…åŒ–åŠŸèƒ½ | 694-822 |

---

## ğŸŠ æ€»ç»“

### å·²ä¿®å¤é—®é¢˜

1. âœ… å†å²è®°å½•æŒä¹…åŒ–åˆ°æ–‡ä»¶
2. âœ… æœåŠ¡å™¨é‡å¯åè‡ªåŠ¨æ¢å¤
3. âœ… æ‰€æœ‰æ“ä½œå®æ—¶ä¿å­˜
4. âœ… å¤šå®¢æˆ·ç«¯æ•°æ®åŒæ­¥

### ç”¨æˆ·ä½“éªŒæå‡

1. ğŸ“ **æ•°æ®æŒä¹…åŒ–** - å†å²è®°å½•æ°¸ä¹…ä¿å­˜
2. ğŸ”„ **è‡ªåŠ¨æ¢å¤** - é‡å¯åè‡ªåŠ¨åŠ è½½
3. ğŸ’¾ **å®æ—¶ä¿å­˜** - æ¯æ¬¡æ“ä½œç«‹å³ä¿å­˜
4. ğŸŒ **å¤šç«¯åŒæ­¥** - æ‰€æœ‰å®¢æˆ·ç«¯å…±äº«æ•°æ®

---

**å®ç°å®Œæˆæ—¶é—´**: 2025-10-03 21:52  
**æœåŠ¡å™¨çŠ¶æ€**: âœ… è¿è¡Œä¸­ (http://192.168.3.68:5000)  
**åŠŸèƒ½çŠ¶æ€**: âœ… å®Œå…¨å¯ç”¨  

---

*ç°åœ¨è¯·åˆ·æ–°æµè§ˆå™¨,ç”Ÿæˆä¸€äº›å›¾ç‰‡,ç„¶åé‡å¯æœåŠ¡å™¨æˆ–åˆ·æ–°é¡µé¢,å†å²è®°å½•åº”è¯¥ä»ç„¶å­˜åœ¨!*

