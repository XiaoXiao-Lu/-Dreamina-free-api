# 📱 服务器地址配置说明

## 🎯 功能说明

现在用户可以在手机或其他设备上自定义服务器地址，无需修改代码。

---

## 🚀 使用方法

### 方法 1: 自动检测（推荐）⭐

**无需配置，直接使用！**

- 在 PC 访问: `http://localhost:5000`
- 在手机访问: `http://192.168.3.68:5000`
- 在平板访问: `http://192.168.3.68:5000`

**系统会自动使用当前访问的地址作为服务器地址。**

---

### 方法 2: 手动配置服务器地址

**适用场景**：
- 服务器和客户端不在同一网络
- 需要通过域名访问
- 需要通过代理访问

**配置步骤**：

1. **打开应用**
   - 访问 Web 应用（任意设备）

2. **打开侧边栏**
   - 点击右上角菜单图标

3. **找到"服务器设置"**
   - 在侧边栏中找到"服务器设置"部分

4. **输入服务器地址**
   - 例如: `http://192.168.3.68:5000`
   - 例如: `http://example.com:5000`
   - 例如: `https://api.example.com`

5. **保存设置**
   - 点击"保存设置"按钮
   - 页面会在 3 秒后自动刷新

6. **验证**
   - 刷新后查看账号列表是否正常显示
   - 尝试生成图片测试连接

---

## 📝 配置示例

### 示例 1: 局域网访问

**场景**: 手机和电脑在同一 WiFi

**配置**:
```
服务器地址: http://192.168.3.68:5000
```

**说明**: 
- `192.168.3.68` 是电脑的局域网 IP
- `5000` 是服务器端口

---

### 示例 2: 公网访问

**场景**: 服务器部署在公网

**配置**:
```
服务器地址: http://example.com:5000
```

或使用 HTTPS:
```
服务器地址: https://api.example.com
```

---

### 示例 3: 使用域名

**场景**: 配置了域名解析

**配置**:
```
服务器地址: http://dreamina.local:5000
```

---

### 示例 4: 恢复默认

**操作**:
1. 打开侧边栏
2. 找到"服务器设置"
3. 点击"恢复默认"按钮
4. 确认操作
5. 页面自动刷新

**效果**: 恢复使用当前访问地址

---

## 🔧 技术实现

### 1. 配置存储

服务器地址存储在浏览器的 `localStorage` 中：

```javascript
localStorage.setItem('dreamina_server_url', 'http://192.168.3.68:5000');
```

### 2. 自动适配

`config.js` 中使用 getter 动态获取服务器地址：

```javascript
api: {
    get baseUrl() {
        const customServer = localStorage.getItem('dreamina_server_url');
        if (customServer && customServer.trim()) {
            return customServer.trim() + '/api';
        }
        return '/api';  // 默认使用相对路径
    }
}
```

### 3. 相对路径优势

使用相对路径 `/api` 的好处：
- ✅ 自动适配当前域名
- ✅ 支持 HTTP 和 HTTPS
- ✅ 支持任意端口
- ✅ 无需手动配置

---

## 📊 配置优先级

1. **用户自定义地址** (最高优先级)
   - 从 `localStorage` 读取
   - 用户在设置中配置

2. **相对路径** (默认)
   - 使用 `/api`
   - 自动适配当前访问地址

---

## ⚠️ 注意事项

### 1. URL 格式要求

**正确格式**:
```
✅ http://192.168.3.68:5000
✅ https://api.example.com
✅ http://example.com:8080
```

**错误格式**:
```
❌ 192.168.3.68:5000          (缺少协议)
❌ http://192.168.3.68:5000/  (末尾有斜杠)
❌ http://192.168.3.68:5000/api (包含 /api)
```

### 2. 跨域问题

如果服务器和客户端不在同一域名，需要确保服务器配置了 CORS：

```python
# server.py 中已配置
from flask_cors import CORS
CORS(app)
```

### 3. 网络连接

确保：
- ✅ 服务器正在运行
- ✅ 防火墙允许访问
- ✅ 网络连接正常
- ✅ 端口没有被占用

### 4. 刷新生效

修改服务器地址后需要刷新页面才能生效。系统会自动在 3 秒后刷新。

---

## 🧪 测试步骤

### 测试 1: 默认配置

1. 不配置服务器地址
2. 在 PC 访问 `http://localhost:5000`
3. 查看账号列表是否正常

**预期**: ✅ 正常显示

---

### 测试 2: 手机访问

1. 不配置服务器地址
2. 在手机访问 `http://192.168.3.68:5000`
3. 查看账号列表是否正常

**预期**: ✅ 正常显示

---

### 测试 3: 自定义地址

1. 在手机打开侧边栏
2. 配置服务器地址: `http://192.168.3.68:5000`
3. 保存并等待刷新
4. 查看账号列表是否正常

**预期**: ✅ 正常显示

---

### 测试 4: 跨设备同步

1. 在 PC 添加一个账号
2. 在手机刷新页面
3. 查看是否显示新账号

**预期**: ✅ 显示新账号

---

## 🔍 故障排除

### 问题 1: 配置后无法连接

**检查**:
1. 服务器地址格式是否正确
2. 服务器是否正在运行
3. 网络连接是否正常
4. 防火墙是否允许访问

**解决**:
- 点击"恢复默认"
- 检查服务器日志
- 使用 `simple-test.html` 测试连接

---

### 问题 2: 保存后没有刷新

**原因**: 浏览器可能阻止了自动刷新

**解决**:
- 手动刷新页面 (F5 或下拉刷新)
- 清除浏览器缓存

---

### 问题 3: 账号列表不显示

**检查**:
1. 打开浏览器控制台查看错误
2. 访问 `/mobile-debug.html` 查看详细信息
3. 检查服务器日志

**解决**:
- 恢复默认服务器设置
- 清除浏览器缓存
- 重启服务器

---

## 📚 相关文档

- `手机缓存问题解决方案.md` - 缓存问题解决
- `多客户端账号同步说明.md` - 账号同步功能
- `测试指南-多客户端同步.md` - 测试步骤

---

## 🎁 使用建议

### 推荐配置

**局域网使用**:
- 不配置服务器地址（使用默认）
- 直接访问对应的 IP 地址

**公网使用**:
- 配置完整的服务器地址
- 使用 HTTPS 加密连接

**开发调试**:
- 使用 `mobile-debug.html` 测试
- 查看浏览器控制台日志
- 监控服务器日志

---

## ✅ 总结

### 优势

1. **灵活性** - 支持多种访问方式
2. **易用性** - 默认自动适配，无需配置
3. **可扩展性** - 支持自定义服务器地址
4. **兼容性** - 支持所有现代浏览器

### 使用场景

| 场景 | 配置方式 | 说明 |
|------|---------|------|
| 本地开发 | 默认 | 使用 localhost |
| 局域网访问 | 默认 | 自动适配 IP |
| 公网访问 | 自定义 | 配置域名或公网 IP |
| 代理访问 | 自定义 | 配置代理地址 |

---

**🎉 现在用户可以在任何设备上灵活配置服务器地址了！**

