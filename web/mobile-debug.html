<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰‹æœºè°ƒè¯•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: monospace;
            padding: 10px;
            background: #f5f5f5;
            font-size: 12px;
        }
        .log {
            background: white;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            word-break: break-all;
        }
        .error {
            background: #fee;
            color: #c00;
        }
        .success {
            background: #efe;
            color: #060;
        }
        .info {
            background: #eef;
            color: #006;
        }
        h1 {
            font-size: 16px;
            margin: 10px 0;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 5px;
            width: 100%;
            margin: 5px 0;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <h1>ğŸ“± æ‰‹æœºè°ƒè¯•å·¥å…·</h1>
    <div id="logs"></div>
    <button onclick="testAll()">ğŸ”„ é‡æ–°æµ‹è¯•</button>

    <script>
        const logs = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            logs.push({ timestamp, message, type });
            render();
            console.log(`[${type}] ${message}`);
        }
        
        function render() {
            const container = document.getElementById('logs');
            container.innerHTML = logs.map(l => 
                `<div class="log ${l.type}">[${l.timestamp}] ${l.message}</div>`
            ).join('');
            container.scrollTop = container.scrollHeight;
        }
        
        // æ•è·æ‰€æœ‰é”™è¯¯
        window.onerror = function(msg, url, line, col, error) {
            log(`âŒ JSé”™è¯¯: ${msg} (${url}:${line}:${col})`, 'error');
            if (error && error.stack) {
                log(`Stack: ${error.stack}`, 'error');
            }
            return false;
        };
        
        window.onunhandledrejection = function(event) {
            log(`âŒ Promiseé”™è¯¯: ${event.reason}`, 'error');
        };
        
        async function testAll() {
            logs.length = 0;
            log('ğŸš€ å¼€å§‹æµ‹è¯•...', 'info');
            
            // 1. æµè§ˆå™¨ä¿¡æ¯
            log(`ğŸ“± User Agent: ${navigator.userAgent}`, 'info');
            log(`ğŸ“± å±å¹•: ${window.innerWidth}x${window.innerHeight}`, 'info');
            
            // 2. æµ‹è¯• ES6 ç‰¹æ€§
            log('--- æµ‹è¯• ES6 ç‰¹æ€§ ---', 'info');
            
            try {
                // æµ‹è¯• async/await
                const testAsync = async () => 'async works';
                await testAsync();
                log('âœ… async/await æ”¯æŒ', 'success');
            } catch (e) {
                log('âŒ async/await ä¸æ”¯æŒ: ' + e.message, 'error');
            }
            
            try {
                // æµ‹è¯•ç®­å¤´å‡½æ•°
                const testArrow = () => 'arrow works';
                testArrow();
                log('âœ… ç®­å¤´å‡½æ•°æ”¯æŒ', 'success');
            } catch (e) {
                log('âŒ ç®­å¤´å‡½æ•°ä¸æ”¯æŒ: ' + e.message, 'error');
            }
            
            try {
                // æµ‹è¯•æ¨¡æ¿å­—ç¬¦ä¸²
                const test = `template ${1+1}`;
                log('âœ… æ¨¡æ¿å­—ç¬¦ä¸²æ”¯æŒ', 'success');
            } catch (e) {
                log('âŒ æ¨¡æ¿å­—ç¬¦ä¸²ä¸æ”¯æŒ: ' + e.message, 'error');
            }
            
            try {
                // æµ‹è¯• fetch
                if (typeof fetch !== 'undefined') {
                    log('âœ… fetch API æ”¯æŒ', 'success');
                } else {
                    log('âŒ fetch API ä¸æ”¯æŒ', 'error');
                }
            } catch (e) {
                log('âŒ fetch API æ£€æµ‹å¤±è´¥: ' + e.message, 'error');
            }
            
            try {
                // æµ‹è¯• Promise
                if (typeof Promise !== 'undefined') {
                    log('âœ… Promise æ”¯æŒ', 'success');
                } else {
                    log('âŒ Promise ä¸æ”¯æŒ', 'error');
                }
            } catch (e) {
                log('âŒ Promise æ£€æµ‹å¤±è´¥: ' + e.message, 'error');
            }
            
            try {
                // æµ‹è¯• class
                class TestClass {}
                log('âœ… class æ”¯æŒ', 'success');
            } catch (e) {
                log('âŒ class ä¸æ”¯æŒ: ' + e.message, 'error');
            }
            
            // 3. æµ‹è¯• localStorage
            log('--- æµ‹è¯• localStorage ---', 'info');
            try {
                localStorage.setItem('test', 'value');
                const val = localStorage.getItem('test');
                if (val === 'value') {
                    log('âœ… localStorage æ”¯æŒ', 'success');
                } else {
                    log('âŒ localStorage è¯»å†™å¼‚å¸¸', 'error');
                }
                localStorage.removeItem('test');
            } catch (e) {
                log('âŒ localStorage ä¸æ”¯æŒ: ' + e.message, 'error');
            }
            
            // 4. æµ‹è¯•åŠ è½½ config.js
            log('--- æµ‹è¯•åŠ è½½ config.js ---', 'info');
            try {
                const script = document.createElement('script');
                script.src = '/js/config.js?v=6';
                script.onload = function() {
                    log('âœ… config.js åŠ è½½æˆåŠŸ', 'success');
                    
                    // æ£€æŸ¥ CONFIG å¯¹è±¡
                    if (typeof CONFIG !== 'undefined') {
                        log('âœ… CONFIG å¯¹è±¡å­˜åœ¨', 'success');
                        log(`CONFIG.api.baseUrl = ${CONFIG.api.baseUrl}`, 'info');
                    } else {
                        log('âŒ CONFIG å¯¹è±¡ä¸å­˜åœ¨', 'error');
                    }
                    
                    // ç»§ç»­æµ‹è¯• API
                    testAPI();
                };
                script.onerror = function() {
                    log('âŒ config.js åŠ è½½å¤±è´¥', 'error');
                };
                document.head.appendChild(script);
            } catch (e) {
                log('âŒ åŠ è½½ config.js å¼‚å¸¸: ' + e.message, 'error');
            }
        }
        
        async function testAPI() {
            log('--- æµ‹è¯• API è°ƒç”¨ ---', 'info');
            
            try {
                log('å‘é€è¯·æ±‚: /api/accounts', 'info');
                const response = await fetch('/api/accounts');
                log(`å“åº”çŠ¶æ€: ${response.status}`, 'info');
                
                const text = await response.text();
                log(`å“åº”å†…å®¹: ${text.substring(0, 200)}`, 'info');
                
                const data = JSON.parse(text);
                
                if (data.success) {
                    log(`âœ… API è°ƒç”¨æˆåŠŸï¼Œè·å–åˆ° ${data.accounts.length} ä¸ªè´¦å·`, 'success');
                    data.accounts.forEach((acc, i) => {
                        log(`è´¦å· ${i+1}: ${acc.description} (${acc.sessionId.substring(0, 20)}...)`, 'info');
                    });
                } else {
                    log(`âŒ API è¿”å›å¤±è´¥: ${data.message}`, 'error');
                }
            } catch (e) {
                log(`âŒ API è°ƒç”¨å¼‚å¸¸: ${e.message}`, 'error');
                log(`Stack: ${e.stack}`, 'error');
            }
            
            // æµ‹è¯•åŠ è½½ api.js
            log('--- æµ‹è¯•åŠ è½½ api.js ---', 'info');
            try {
                const script = document.createElement('script');
                script.src = '/js/api.js?v=6';
                script.onload = function() {
                    log('âœ… api.js åŠ è½½æˆåŠŸ', 'success');
                    
                    // æ£€æŸ¥ storage å¯¹è±¡
                    if (typeof storage !== 'undefined') {
                        log('âœ… storage å¯¹è±¡å­˜åœ¨', 'success');
                        testStorage();
                    } else {
                        log('âŒ storage å¯¹è±¡ä¸å­˜åœ¨', 'error');
                    }
                };
                script.onerror = function() {
                    log('âŒ api.js åŠ è½½å¤±è´¥', 'error');
                };
                document.head.appendChild(script);
            } catch (e) {
                log('âŒ åŠ è½½ api.js å¼‚å¸¸: ' + e.message, 'error');
            }
        }
        
        async function testStorage() {
            log('--- æµ‹è¯• StorageManager ---', 'info');
            
            try {
                log('è°ƒç”¨ storage.getAccounts()...', 'info');
                const accounts = await storage.getAccounts();
                log(`âœ… storage.getAccounts() æˆåŠŸï¼Œè·å–åˆ° ${accounts.length} ä¸ªè´¦å·`, 'success');
                
                const currentAccount = storage.getCurrentAccount();
                if (currentAccount) {
                    log(`âœ… å½“å‰è´¦å·: ${currentAccount.description}`, 'success');
                } else {
                    log('âš ï¸ æ²¡æœ‰å½“å‰è´¦å·', 'info');
                }
            } catch (e) {
                log(`âŒ StorageManager æµ‹è¯•å¤±è´¥: ${e.message}`, 'error');
                log(`Stack: ${e.stack}`, 'error');
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•
        window.onload = function() {
            testAll();
        };
    </script>
</body>
</html>

