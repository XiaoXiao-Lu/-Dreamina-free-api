# 🔍 诊断新标记功能

## 问题: 新生成的照片没有显示特殊标记

### 📋 诊断步骤

#### 1️⃣ 测试 CSS 样式 (最快速)

**访问测试页面:**
```
http://localhost:5000/test-new-badge.html
```

**预期结果:**
- 第一个卡片应该有紫蓝色背景和"⭐ 新"徽章
- 第二个卡片应该是普通灰色背景

**如果测试页面显示正常:**
- ✅ CSS 样式没问题
- ❌ 问题在于数据层或渲染逻辑

**如果测试页面也不正常:**
- ❌ CSS 文件可能没有正确加载
- 👉 执行步骤 2

---

#### 2️⃣ 清除浏览器缓存

**方法 1: 硬刷新**
```
按 Ctrl + F5 (Windows)
或 Cmd + Shift + R (Mac)
```

**方法 2: 清除缓存**
```
1. 按 F12 打开开发者工具
2. 右键点击刷新按钮
3. 选择"清空缓存并硬性重新加载"
```

**方法 3: 手动清除**
```
1. 按 Ctrl + Shift + Delete
2. 选择"缓存的图片和文件"
3. 点击"清除数据"
```

---

#### 3️⃣ 检查文件版本

**打开开发者工具 (F12) → Network 标签**

刷新页面,查找以下文件:
- `style.css?v=17` ✅ 应该是 v=17
- `api.js?v=12` ✅ 应该是 v=12
- `ui.js?v=12` ✅ 应该是 v=12

**如果版本号不对:**
```
1. 重启服务器
2. 清除浏览器缓存
3. 再次刷新页面
```

---

#### 4️⃣ 检查控制台日志

**打开开发者工具 (F12) → Console 标签**

**生成一张新图片,观察日志:**

应该看到以下日志:
```
[Storage] 添加历史记录,isNew: true
[Storage] 历史记录已保存,ID: xxxxx
[UI] 渲染新生成的照片: xxxxx true
```

**如果没有看到这些日志:**
- ❌ JavaScript 文件可能没有正确加载
- 👉 执行步骤 3 检查版本号

**如果看到日志但没有显示效果:**
- ❌ CSS 样式可能没有正确应用
- 👉 执行步骤 5

---

#### 5️⃣ 检查 DOM 元素

**打开开发者工具 (F12) → Elements 标签**

**找到历史记录卡片,检查:**

1. **检查 class 属性:**
   ```html
   <div class="history-item history-item-new" data-item-id="...">
   ```
   ✅ 应该包含 `history-item-new` 类

2. **检查徽章元素:**
   ```html
   <div class="new-badge"><i class="fas fa-star"></i> 新</div>
   ```
   ✅ 应该存在这个元素

**如果 class 不存在:**
- ❌ 数据中的 `isNew` 标记可能丢失
- 👉 执行步骤 6

**如果 class 存在但没有样式:**
- ❌ CSS 样式没有正确加载
- 👉 执行步骤 2 清除缓存

---

#### 6️⃣ 检查历史记录数据

**打开开发者工具 (F12) → Console 标签**

**执行以下命令:**
```javascript
// 获取历史记录
fetch('/api/history')
  .then(r => r.json())
  .then(data => {
    console.log('历史记录:', data.history);
    // 检查第一条记录
    const first = data.history[0];
    console.log('第一条记录 isNew:', first.isNew);
  });
```

**预期结果:**
- 最新的记录应该有 `isNew: true`

**如果没有 isNew 字段:**
- ❌ 服务器端没有保存 isNew 标记
- 👉 执行步骤 7

---

#### 7️⃣ 检查服务器日志

**查看服务器控制台输出**

**生成新图片时,应该看到:**
```
添加历史记录, isNew: True
```

**如果没有看到:**
- ❌ 服务器代码可能没有更新
- 👉 重启服务器

---

#### 8️⃣ 重启服务器

**停止服务器:**
```
双击: stop_server.bat
或按 Ctrl+C 关闭服务器窗口
```

**启动服务器:**
```
双击: start_server.bat
或 start_server_background.vbs
```

**清除浏览器缓存并刷新页面**

---

### 🐛 常见问题

#### Q1: 测试页面显示正常,但主应用不显示

**原因:** 数据层问题,`isNew` 标记没有正确保存

**解决:**
1. 打开开发者工具 → Console
2. 生成新图片
3. 查看是否有 `[Storage] 添加历史记录,isNew: true` 日志
4. 如果没有,检查 `api.js` 文件是否正确加载 (v=12)

---

#### Q2: 旧的历史记录也显示新标记

**原因:** 历史数据中残留了 `isNew` 标记

**解决:**
1. 打开 `web/history.json`
2. 手动删除所有 `"isNew": true` 字段
3. 或者清空历史记录重新生成

---

#### Q3: 点击查看后标记没有消失

**原因:** 标记为已查看的 API 调用失败

**解决:**
1. 打开开发者工具 → Network
2. 点击查看图片
3. 查找 `/api/history/xxx/viewed` 请求
4. 检查请求是否成功 (状态码 200)
5. 如果失败,查看服务器日志

---

#### Q4: 刷新页面后标记消失

**原因:** 服务器没有正确保存 `isNew` 标记

**解决:**
1. 检查 `web/history.json` 文件
2. 确认新记录包含 `"isNew": true`
3. 如果没有,重启服务器

---

#### Q5: 动画不流畅或卡顿

**原因:** 浏览器性能问题或 GPU 加速未启用

**解决:**
1. 关闭其他占用资源的标签页
2. 启用浏览器硬件加速:
   - Chrome: 设置 → 系统 → 使用硬件加速
3. 更新显卡驱动

---

### 🔧 快速修复命令

**在浏览器控制台执行:**

```javascript
// 1. 检查 CSS 是否加载
console.log('CSS 版本:', document.querySelector('link[href*="style.css"]').href);

// 2. 检查 JS 是否加载
console.log('API.js 版本:', document.querySelector('script[src*="api.js"]').src);
console.log('UI.js 版本:', document.querySelector('script[src*="ui.js"]').src);

// 3. 检查历史记录数据
fetch('/api/history')
  .then(r => r.json())
  .then(data => console.table(data.history.slice(0, 5)));

// 4. 手动添加测试数据
fetch('/api/history', {
  method: 'POST',
  headers: {'Content-Type': 'application/json'},
  body: JSON.stringify({
    prompt: '测试新标记功能',
    model: '4.0',
    resolution: '4k',
    ratio: '3:4',
    mode: 't2i',
    images: ['https://example.com/test.jpg'],
    isNew: true
  })
}).then(r => r.json()).then(console.log);

// 5. 强制重新渲染历史记录
ui.renderHistory(true);
```

---

### ✅ 验证清单

完成以下检查,确认功能正常:

- [ ] 测试页面显示正常 (http://localhost:5000/test-new-badge.html)
- [ ] CSS 文件版本正确 (v=17)
- [ ] JS 文件版本正确 (v=12)
- [ ] 浏览器缓存已清除
- [ ] 服务器已重启
- [ ] 控制台有正确的日志输出
- [ ] 新生成的照片显示紫蓝色背景
- [ ] 新生成的照片显示"⭐ 新"徽章
- [ ] 边框有呼吸动画
- [ ] 徽章有浮动动画
- [ ] 星星有旋转动画
- [ ] 点击查看后标记消失
- [ ] 刷新页面后未查看的标记仍然保留

---

### 📞 仍然无法解决?

如果按照以上步骤仍然无法解决,请提供以下信息:

1. **浏览器信息**
   - 浏览器名称和版本
   - 操作系统

2. **控制台日志**
   - 打开开发者工具 → Console
   - 复制所有日志信息

3. **Network 信息**
   - 打开开发者工具 → Network
   - 截图或复制相关请求

4. **服务器日志**
   - 复制服务器控制台输出

5. **history.json 内容**
   - 复制最新的一条记录

---

**祝您调试顺利! 🎉**

